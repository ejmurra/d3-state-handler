define(['exports', 'module'], function (exports, module) {
    // polyfill object assign from MDN
    'use strict';

    if (!Object.assign) {
        Object.defineProperty(Object, 'assign', {
            enumerable: false,
            configurable: true,
            writable: true,
            value: function value(target) {
                'use strict';
                if (target === undefined || target === null) {
                    throw new TypeError('Cannot convert first argument to object');
                }

                var to = Object(target);
                for (var i = 1; i < arguments.length; i++) {
                    var nextSource = arguments[i];
                    if (nextSource === undefined || nextSource === null) {
                        continue;
                    }
                    nextSource = Object(nextSource);

                    var keysArray = Object.keys(nextSource);
                    for (var nextIndex = 0, len = keysArray.length; nextIndex < len; nextIndex++) {
                        var nextKey = keysArray[nextIndex];
                        var desc = Object.getOwnPropertyDescriptor(nextSource, nextKey);
                        if (desc !== undefined && desc.enumerable) {
                            to[nextKey] = nextSource[nextKey];
                        }
                    }
                }
                return to;
            }
        });
    }

    // Stolen from http://stackoverflow.com/a/8668283
    function arrayObjectIndexOf(myArray, searchTerm, property) {
        for (var i = 0, len = myArray.length; i < len; i++) {
            if (myArray[i][property] === searchTerm) return i;
        }
        return -1;
    }

    var StateHandler = function StateHandler(Window, opts) {
        var _this = this;

        /*
         * Private vars
         */

        // Used to hold states and keep track of which state the user is currently interacting with
        var currentIndex = 0;
        var states = [];

        // This function just lets data flow through it unmutated. Used as a filler for missing methods on state objects
        var substitute = function substitute(data) {
            return data;
        };

        var options = opts || {
            loop: false, // Whether last state should hook into first state and vice versa
            init: substitute, // Function to run before calling the first state
            jumpState: {}, // Contract states must adhere to when returning from jumpOut
            data: {}, // Object passed between states. Every method on a state receives and returns a data object
            load: substitute // Function to be called when a user loads a non-first state from a URL. This function
            // receives data as a parameter and should return an object that is equal to jumpState.
        };

        // For easy reference and so that const is enforced by babel
        var jumpState = options.jumpState;

        // For easy reference
        var data = options.data;

        // When states register, their methods are stored in here so that they are simpler and can be added to html pushState
        var methodRegister = {};

        /*
         * Private Methods
         */
        var registerState = function registerState(state) {

            var avail = !methodRegister[state.name];
            if (!avail) throw new Error('State ' + state.name + ' already exists!');

            methodRegister[state.name] = {
                render: state.render,
                fromNext: state.fromNext || substitute,
                fromPrev: state.fromPrev || substitute,
                toNext: state.toNext || substitute,
                toPrev: state.toPrev || substitute,
                jumpOut: state.jumpOut || substitute,
                jumpIn: state.jumpIn || substitute,
                resize: state.resize || state.render
            };

            if (states.length) states[states.length - 1].next = state.name;

            state = {
                prev: states.length ? states[states.length - 1].name : null,
                name: state.name,
                next: null,
                url: '#' + _this.name
            };

            states.push(state);

            return state;
        };

        var resize = function resize() {
            var xData = Object.assign({}, data);
            xData = states[currentIndex].resize(xData);
            data = Object.assign({}, data, xData);
        };

        /*
         * Public Methods
         */

        var add = function add(state) {
            state.name = state.name || String(states.length);
            state = registerState(state);
            if (states.length === 1) Window.history.pushState(state, state.name, '#' + state.name);
        };

        var currentState = function currentState() {
            return states[currentIndex];
        };

        var remove = function remove(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            if (index > -1) array.splice(index, 1);
        };

        var loadState = function loadState(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            var targetState = states[index];

            if (index > -1) {
                var xData = options.load(Object.assign({}, data));

                // TODO: check xData against jumpState

                // Call transition methods
                xData = methodRegister[targetState.name].jumpIn(Object.assign({}, jumpState));
                xData = methodRegister[targetState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = index;
                Window.history.pushState(targetState, targetState.name, '#' + targetState.name);
            } else {
                throw new Error('State ' + name + ' does not exist');
            }
        };

        var jumpTo = function jumpTo(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            var currentState = states[currentIndex];
            var targetState = states[index];

            if (index > -1) {
                var xData = Object.assign({}, data);
                xData = methodRegister[currentState.name].jumpOut(xData);

                // TODO: check xData against jumpState

                // Call transition methods
                xData = methodRegister[targetState.name].jumpIn(Object.assign({}, jumpState));
                xData = methodRegister[targetState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = index;
                Window.history.pushState(targetState, targetState.name, '#' + targetState.name);
            } else {
                throw new Error('State ' + name + ' does not exist');
            }
        };

        var next = function next() {
            var thisState = states[currentIndex];
            var nextStateName = thisState.next;

            if (nextStateName) {
                var nextState = states[arrayObjectIndexOf(states, nextStateName, 'name')];
                var xData = Object.assign({}, data);

                // Call transition methods
                xData = methodRegister[thisState.name].toNext(xData);
                xData = methodRegister[nextState.name].fromPrev(xData);
                xData = methodRegister[nextState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = currentIndex + 1 < states.length ? currentIndex + 1 : 0;
                Window.history.pushState(nextState, nextState.name, '#' + nextState.name);
            } else {
                throw new Error('No state after current state (' + JSON.stringify(thisState) + ')');
            }
        };

        var prev = function prev() {
            var thisState = states[currentIndex];
            var prevStateName = thisState.prev;

            if (prevStateName) {
                var prevState = states[arrayObjectIndexOf(states, prevStateName, 'name')];
                var xData = Object.assign({}, data);

                // Cal transition methods
                xData = methodRegister[thisState.name].toPrev(xData);
                xData = methodRegister[prevState.name].fromNext(xData);
                xData = methodRegister[prevState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = currentIndex - 1 >= 0 ? currentIndex - 1 : states.length - 1;
                Window.history.pushState(prevState, prevState.name, 'name');
            } else {
                throw new Error('No state before current state (' + JSON.stringify(thisState) + ')');
            }
        };

        var start = function start(fn) {
            // Set up listeners for popState and resize
            Window.addEventListener('popstate', function (e) {
                if (Window.history.state.name === null) {
                    var xData = Object.assign({}, data);
                    xData = !fn ? options.init(xData) : fn(xData);
                    xData = states[0].render(xData);
                    data = Object.assign({}, data, xData);
                } else {
                    jumpTo(Window.history.state.name);
                }
            });
            Window.addEventListener('resize', function (e) {
                resize();
            });

            // Bootstrap application
            if (!Window.location.hash || Window.location.hash.slice(1) === states[0].name) {
                var xData = Object.assign({}, data);
                xData = !fn ? options.init(xData) : fn(xData);
                xData = methodRegister[states[0].name].render(xData);
                data = Object.assign({}, data, xData);
            } else {
                jumpTo(Window.history.state.name);
            }
        };

        var api = {
            next: next,
            add: add,
            currentState: currentState,
            prev: prev,
            remove: remove,
            load: loadState,
            jumpTo: jumpTo,
            start: start
        };

        return api;
    };

    module.exports = StateHandler;
});
//# sourceMappingURL=data:application/json;base64,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LENBQUMsRUFBRSxFQUFDLElBQUksRUFBQyxLQUFLLENBQUMsQ0FBQzthQUN2QyxNQUFNO0FBQ0gsc0JBQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNyQztTQUdKLENBQUM7O0FBRUYsWUFBSSxHQUFHLEdBQUc7QUFDTixnQkFBSSxFQUFFLElBQUk7QUFDVixlQUFHLEVBQUUsR0FBRztBQUNSLHdCQUFZLEVBQUUsWUFBWTtBQUMxQixnQkFBSSxFQUFFLElBQUk7QUFDVixrQkFBTSxFQUFFLE1BQU07QUFDZCxnQkFBSSxFQUFFLFNBQVM7QUFDZixrQkFBTSxFQUFFLE1BQU07QUFDZCxpQkFBSyxFQUFFLEtBQUs7U0FDZixDQUFDOztBQUVGLGVBQU8sR0FBRyxDQUFDO0tBQ2QsQ0FBQzs7cUJBRWEsWUFBWSIsImZpbGUiOiJkMy1zdGF0ZS1oYW5kbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gcG9seWZpbGwgb2JqZWN0IGFzc2lnbiBmcm9tIE1ETlxuaWYgKCFPYmplY3QuYXNzaWduKSB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE9iamVjdCwgJ2Fzc2lnbicsIHtcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgIHZhbHVlOiBmdW5jdGlvbih0YXJnZXQpIHtcbiAgICAgICAgICAgICd1c2Ugc3RyaWN0JztcbiAgICAgICAgICAgIGlmICh0YXJnZXQgPT09IHVuZGVmaW5lZCB8fCB0YXJnZXQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCBmaXJzdCBhcmd1bWVudCB0byBvYmplY3QnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHRvID0gT2JqZWN0KHRhcmdldCk7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBuZXh0U291cmNlID0gYXJndW1lbnRzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChuZXh0U291cmNlID09PSB1bmRlZmluZWQgfHwgbmV4dFNvdXJjZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmV4dFNvdXJjZSA9IE9iamVjdChuZXh0U291cmNlKTtcblxuICAgICAgICAgICAgICAgIHZhciBrZXlzQXJyYXkgPSBPYmplY3Qua2V5cyhuZXh0U291cmNlKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBuZXh0SW5kZXggPSAwLCBsZW4gPSBrZXlzQXJyYXkubGVuZ3RoOyBuZXh0SW5kZXggPCBsZW47IG5leHRJbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXh0S2V5ID0ga2V5c0FycmF5W25leHRJbmRleF07XG4gICAgICAgICAgICAgICAgICAgIHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihuZXh0U291cmNlLCBuZXh0S2V5KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc2MgIT09IHVuZGVmaW5lZCAmJiBkZXNjLmVudW1lcmFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvW25leHRLZXldID0gbmV4dFNvdXJjZVtuZXh0S2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0bztcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG4vLyBTdG9sZW4gZnJvbSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS84NjY4MjgzXG5mdW5jdGlvbiBhcnJheU9iamVjdEluZGV4T2YobXlBcnJheSwgc2VhcmNoVGVybSwgcHJvcGVydHkpIHtcbiAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBteUFycmF5Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGlmIChteUFycmF5W2ldW3Byb3BlcnR5XSA9PT0gc2VhcmNoVGVybSkgcmV0dXJuIGk7XG4gICAgfVxuICAgIHJldHVybiAtMTtcbn1cblxuY29uc3QgU3RhdGVIYW5kbGVyID0gZnVuY3Rpb24gU3RhdGVIYW5kbGVyKFdpbmRvdyxvcHRzKSB7XG5cbiAgICAvKlxuICAgICAqIFByaXZhdGUgdmFyc1xuICAgICAqL1xuXG4gICAgLy8gVXNlZCB0byBob2xkIHN0YXRlcyBhbmQga2VlcCB0cmFjayBvZiB3aGljaCBzdGF0ZSB0aGUgdXNlciBpcyBjdXJyZW50bHkgaW50ZXJhY3Rpbmcgd2l0aFxuICAgIGxldCBjdXJyZW50SW5kZXggPSAwO1xuICAgIGxldCBzdGF0ZXMgPSBbXTtcblxuICAgIC8vIFRoaXMgZnVuY3Rpb24ganVzdCBsZXRzIGRhdGEgZmxvdyB0aHJvdWdoIGl0IHVubXV0YXRlZC4gVXNlZCBhcyBhIGZpbGxlciBmb3IgbWlzc2luZyBtZXRob2RzIG9uIHN0YXRlIG9iamVjdHNcbiAgICBjb25zdCBzdWJzdGl0dXRlID0gZnVuY3Rpb24oZGF0YSkge3JldHVybiBkYXRhfTtcblxuICAgIGxldCBvcHRpb25zID0gb3B0cyB8fCB7XG4gICAgICAgICAgICBsb29wOiBmYWxzZSwgICAgICAgIC8vIFdoZXRoZXIgbGFzdCBzdGF0ZSBzaG91bGQgaG9vayBpbnRvIGZpcnN0IHN0YXRlIGFuZCB2aWNlIHZlcnNhXG4gICAgICAgICAgICBpbml0OiBzdWJzdGl0dXRlLCAgIC8vIEZ1bmN0aW9uIHRvIHJ1biBiZWZvcmUgY2FsbGluZyB0aGUgZmlyc3Qgc3RhdGVcbiAgICAgICAgICAgIGp1bXBTdGF0ZToge30sICAgICAgLy8gQ29udHJhY3Qgc3RhdGVzIG11c3QgYWRoZXJlIHRvIHdoZW4gcmV0dXJuaW5nIGZyb20ganVtcE91dFxuICAgICAgICAgICAgZGF0YToge30sICAgICAgICAgICAvLyBPYmplY3QgcGFzc2VkIGJldHdlZW4gc3RhdGVzLiBFdmVyeSBtZXRob2Qgb24gYSBzdGF0ZSByZWNlaXZlcyBhbmQgcmV0dXJucyBhIGRhdGEgb2JqZWN0XG4gICAgICAgICAgICBsb2FkOiBzdWJzdGl0dXRlICAgIC8vIEZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIGEgdXNlciBsb2FkcyBhIG5vbi1maXJzdCBzdGF0ZSBmcm9tIGEgVVJMLiBUaGlzIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZWNlaXZlcyBkYXRhIGFzIGEgcGFyYW1ldGVyIGFuZCBzaG91bGQgcmV0dXJuIGFuIG9iamVjdCB0aGF0IGlzIGVxdWFsIHRvIGp1bXBTdGF0ZS5cbiAgICAgICAgfTtcblxuICAgIC8vIEZvciBlYXN5IHJlZmVyZW5jZSBhbmQgc28gdGhhdCBjb25zdCBpcyBlbmZvcmNlZCBieSBiYWJlbFxuICAgIGNvbnN0IGp1bXBTdGF0ZSA9IG9wdGlvbnMuanVtcFN0YXRlO1xuXG4gICAgLy8gRm9yIGVhc3kgcmVmZXJlbmNlXG4gICAgbGV0IGRhdGEgPSBvcHRpb25zLmRhdGE7XG5cbiAgICAvLyBXaGVuIHN0YXRlcyByZWdpc3RlciwgdGhlaXIgbWV0aG9kcyBhcmUgc3RvcmVkIGluIGhlcmUgc28gdGhhdCB0aGV5IGFyZSBzaW1wbGVyIGFuZCBjYW4gYmUgYWRkZWQgdG8gaHRtbCBwdXNoU3RhdGVcbiAgICBsZXQgbWV0aG9kUmVnaXN0ZXIgPSB7fTtcblxuICAgIC8qXG4gICAgICogUHJpdmF0ZSBNZXRob2RzXG4gICAgICovXG4gICAgbGV0IHJlZ2lzdGVyU3RhdGUgPSAoc3RhdGUpID0+IHtcblxuICAgICAgICBsZXQgYXZhaWwgPSAhbWV0aG9kUmVnaXN0ZXJbc3RhdGUubmFtZV07XG4gICAgICAgIGlmICghYXZhaWwpIHRocm93IG5ldyBFcnJvcihgU3RhdGUgJHtzdGF0ZS5uYW1lfSBhbHJlYWR5IGV4aXN0cyFgKTtcblxuICAgICAgICBtZXRob2RSZWdpc3RlcltzdGF0ZS5uYW1lXSA9IHtcbiAgICAgICAgICAgIHJlbmRlcjogc3RhdGUucmVuZGVyLFxuICAgICAgICAgICAgZnJvbU5leHQ6IHN0YXRlLmZyb21OZXh0IHx8IHN1YnN0aXR1dGUsXG4gICAgICAgICAgICBmcm9tUHJldjogc3RhdGUuZnJvbVByZXYgfHwgc3Vic3RpdHV0ZSxcbiAgICAgICAgICAgIHRvTmV4dDogc3RhdGUudG9OZXh0IHx8IHN1YnN0aXR1dGUsXG4gICAgICAgICAgICB0b1ByZXY6IHN0YXRlLnRvUHJldiB8fCBzdWJzdGl0dXRlLFxuICAgICAgICAgICAganVtcE91dDogc3RhdGUuanVtcE91dCB8fCBzdWJzdGl0dXRlLFxuICAgICAgICAgICAganVtcEluOiBzdGF0ZS5qdW1wSW4gfHwgc3Vic3RpdHV0ZSxcbiAgICAgICAgICAgIHJlc2l6ZTogc3RhdGUucmVzaXplIHx8IHN0YXRlLnJlbmRlclxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChzdGF0ZXMubGVuZ3RoKSBzdGF0ZXNbc3RhdGVzLmxlbmd0aCAtIDFdLm5leHQgPSBzdGF0ZS5uYW1lO1xuXG4gICAgICAgIHN0YXRlID0ge1xuICAgICAgICAgICAgcHJldjogc3RhdGVzLmxlbmd0aCA/IHN0YXRlc1tzdGF0ZXMubGVuZ3RoIC0gMV0ubmFtZTogbnVsbCxcbiAgICAgICAgICAgIG5hbWU6IHN0YXRlLm5hbWUsXG4gICAgICAgICAgICBuZXh0OiBudWxsLFxuICAgICAgICAgICAgdXJsOiBgIyR7dGhpcy5uYW1lfWBcbiAgICAgICAgfTtcblxuICAgICAgICBzdGF0ZXMucHVzaChzdGF0ZSk7XG5cbiAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH07XG5cbiAgICBsZXQgcmVzaXplID0gKCkgPT4ge1xuICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICB4RGF0YSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdLnJlc2l6ZSh4RGF0YSk7XG4gICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgIH07XG5cbiAgICAvKlxuICAgICAqIFB1YmxpYyBNZXRob2RzXG4gICAgICovXG5cbiAgICBsZXQgYWRkID0gKHN0YXRlKSA9PiB7XG4gICAgICAgIHN0YXRlLm5hbWUgPSBzdGF0ZS5uYW1lIHx8IFN0cmluZyhzdGF0ZXMubGVuZ3RoKTtcbiAgICAgICAgc3RhdGUgPSByZWdpc3RlclN0YXRlKHN0YXRlKTtcbiAgICAgICAgaWYgKHN0YXRlcy5sZW5ndGggPT09IDEpIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZSxzdGF0ZS5uYW1lLGAjJHtzdGF0ZS5uYW1lfWApXG4gICAgfTtcblxuICAgIGxldCBjdXJyZW50U3RhdGUgPSAoKSA9PiB7XG4gICAgICAgIHJldHVybiBzdGF0ZXNbY3VycmVudEluZGV4XTtcbiAgICB9O1xuXG4gICAgbGV0IHJlbW92ZSA9IChuYW1lKSA9PiB7XG4gICAgICAgIGxldCBpbmRleCA9IGFycmF5T2JqZWN0SW5kZXhPZihzdGF0ZXMsbmFtZSwnbmFtZScpO1xuICAgICAgICBpZiAoaW5kZXggPiAtMSkgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9O1xuXG4gICAgbGV0IGxvYWRTdGF0ZSA9IChuYW1lKSA9PiB7XG4gICAgICAgIGxldCBpbmRleCA9IGFycmF5T2JqZWN0SW5kZXhPZihzdGF0ZXMsbmFtZSwnbmFtZScpO1xuICAgICAgICBsZXQgdGFyZ2V0U3RhdGUgPSBzdGF0ZXNbaW5kZXhdO1xuXG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBsZXQgeERhdGEgPSBvcHRpb25zLmxvYWQoT2JqZWN0LmFzc2lnbih7fSxkYXRhKSk7XG5cbiAgICAgICAgICAgIC8vIFRPRE86IGNoZWNrIHhEYXRhIGFnYWluc3QganVtcFN0YXRlXG5cbiAgICAgICAgICAgIC8vIENhbGwgdHJhbnNpdGlvbiBtZXRob2RzXG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3RhcmdldFN0YXRlLm5hbWVdLmp1bXBJbihPYmplY3QuYXNzaWduKHt9LGp1bXBTdGF0ZSkpO1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3Rlclt0YXJnZXRTdGF0ZS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuXG4gICAgICAgICAgICAvLyBDbGVhbiB1cFxuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSh0YXJnZXRTdGF0ZSx0YXJnZXRTdGF0ZS5uYW1lLGAjJHt0YXJnZXRTdGF0ZS5uYW1lfWApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0YXRlICR7bmFtZX0gZG9lcyBub3QgZXhpc3RgKVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBqdW1wVG8gPSAobmFtZSkgPT4ge1xuICAgICAgICBsZXQgaW5kZXggPSBhcnJheU9iamVjdEluZGV4T2Yoc3RhdGVzLG5hbWUsJ25hbWUnKTtcbiAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdO1xuICAgICAgICBsZXQgdGFyZ2V0U3RhdGUgPSBzdGF0ZXNbaW5kZXhdO1xuXG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3RlcltjdXJyZW50U3RhdGUubmFtZV0uanVtcE91dCh4RGF0YSk7XG5cbiAgICAgICAgICAgIC8vIFRPRE86IGNoZWNrIHhEYXRhIGFnYWluc3QganVtcFN0YXRlXG5cblxuICAgICAgICAgICAgLy8gQ2FsbCB0cmFuc2l0aW9uIG1ldGhvZHNcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbdGFyZ2V0U3RhdGUubmFtZV0uanVtcEluKE9iamVjdC5hc3NpZ24oe30sanVtcFN0YXRlKSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3RhcmdldFN0YXRlLm5hbWVdLnJlbmRlcih4RGF0YSk7XG5cbiAgICAgICAgICAgIC8vIENsZWFuIHVwXG4gICAgICAgICAgICBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhLHhEYXRhKTtcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgV2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHRhcmdldFN0YXRlLHRhcmdldFN0YXRlLm5hbWUsYCMke3RhcmdldFN0YXRlLm5hbWV9YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU3RhdGUgJHtuYW1lfSBkb2VzIG5vdCBleGlzdGApO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBuZXh0ID0gKCkgPT4ge1xuICAgICAgICBsZXQgdGhpc1N0YXRlID0gc3RhdGVzW2N1cnJlbnRJbmRleF07XG4gICAgICAgIGxldCBuZXh0U3RhdGVOYW1lID0gdGhpc1N0YXRlLm5leHQ7XG5cbiAgICAgICAgaWYgKG5leHRTdGF0ZU5hbWUpIHtcbiAgICAgICAgICAgIGxldCBuZXh0U3RhdGUgPSBzdGF0ZXNbYXJyYXlPYmplY3RJbmRleE9mKHN0YXRlcyxuZXh0U3RhdGVOYW1lLCduYW1lJyldO1xuICAgICAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcblxuICAgICAgICAgICAgLy8gQ2FsbCB0cmFuc2l0aW9uIG1ldGhvZHNcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbdGhpc1N0YXRlLm5hbWVdLnRvTmV4dCh4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW25leHRTdGF0ZS5uYW1lXS5mcm9tUHJldih4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW25leHRTdGF0ZS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuXG4gICAgICAgICAgICAvLyBDbGVhbiB1cFxuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSAoY3VycmVudEluZGV4ICsgMSA8IHN0YXRlcy5sZW5ndGgpID8gY3VycmVudEluZGV4ICsgMSA6IDA7XG4gICAgICAgICAgICBXaW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUobmV4dFN0YXRlLG5leHRTdGF0ZS5uYW1lLGAjJHtuZXh0U3RhdGUubmFtZX1gKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc3RhdGUgYWZ0ZXIgY3VycmVudCBzdGF0ZSAoJHtKU09OLnN0cmluZ2lmeSh0aGlzU3RhdGUpfSlgKVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBwcmV2ID0gKCkgPT4ge1xuICAgICAgICBsZXQgdGhpc1N0YXRlID0gc3RhdGVzW2N1cnJlbnRJbmRleF07XG4gICAgICAgIGxldCBwcmV2U3RhdGVOYW1lID0gdGhpc1N0YXRlLnByZXY7XG5cbiAgICAgICAgaWYgKHByZXZTdGF0ZU5hbWUpIHtcbiAgICAgICAgICAgIGxldCBwcmV2U3RhdGUgPSBzdGF0ZXNbYXJyYXlPYmplY3RJbmRleE9mKHN0YXRlcyxwcmV2U3RhdGVOYW1lLCduYW1lJyldO1xuICAgICAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcblxuICAgICAgICAgICAgLy8gQ2FsIHRyYW5zaXRpb24gbWV0aG9kc1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3Rlclt0aGlzU3RhdGUubmFtZV0udG9QcmV2KHhEYXRhKTtcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbcHJldlN0YXRlLm5hbWVdLmZyb21OZXh0KHhEYXRhKTtcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbcHJldlN0YXRlLm5hbWVdLnJlbmRlcih4RGF0YSk7XG5cbiAgICAgICAgICAgIC8vIENsZWFuIHVwXG4gICAgICAgICAgICBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhLHhEYXRhKTtcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IChjdXJyZW50SW5kZXggLSAxID49IDApID8gY3VycmVudEluZGV4IC0gMSA6IHN0YXRlcy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgV2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHByZXZTdGF0ZSxwcmV2U3RhdGUubmFtZSwnbmFtZScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBzdGF0ZSBiZWZvcmUgY3VycmVudCBzdGF0ZSAoJHtKU09OLnN0cmluZ2lmeSh0aGlzU3RhdGUpfSlgKVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBzdGFydCA9IChmbikgPT4ge1xuICAgICAgICAvLyBTZXQgdXAgbGlzdGVuZXJzIGZvciBwb3BTdGF0ZSBhbmQgcmVzaXplXG4gICAgICAgIFdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsKGUpID0+IHtcbiAgICAgICAgICAgIGlmIChXaW5kb3cuaGlzdG9yeS5zdGF0ZS5uYW1lID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcbiAgICAgICAgICAgICAgICB4RGF0YSA9ICFmbiA/IG9wdGlvbnMuaW5pdCh4RGF0YSkgOiBmbih4RGF0YSk7XG4gICAgICAgICAgICAgICAgeERhdGEgPSBzdGF0ZXNbMF0ucmVuZGVyKHhEYXRhKTtcbiAgICAgICAgICAgICAgICBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhLHhEYXRhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAganVtcFRvKFdpbmRvdy5oaXN0b3J5LnN0YXRlLm5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgV2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsKGUpID0+IHtcbiAgICAgICAgICAgIHJlc2l6ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBCb290c3RyYXAgYXBwbGljYXRpb25cbiAgICAgICAgaWYgKCFXaW5kb3cubG9jYXRpb24uaGFzaCB8fCBXaW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSA9PT0gc3RhdGVzWzBdLm5hbWUpIHtcbiAgICAgICAgICAgIGxldCB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9ICFmbiA/IG9wdGlvbnMuaW5pdCh4RGF0YSkgOiBmbih4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3N0YXRlc1swXS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBqdW1wVG8oV2luZG93Lmhpc3Rvcnkuc3RhdGUubmFtZSk7XG4gICAgICAgIH1cblxuXG4gICAgfTtcblxuICAgIGxldCBhcGkgPSB7XG4gICAgICAgIG5leHQ6IG5leHQsXG4gICAgICAgIGFkZDogYWRkLFxuICAgICAgICBjdXJyZW50U3RhdGU6IGN1cnJlbnRTdGF0ZSxcbiAgICAgICAgcHJldjogcHJldixcbiAgICAgICAgcmVtb3ZlOiByZW1vdmUsXG4gICAgICAgIGxvYWQ6IGxvYWRTdGF0ZSxcbiAgICAgICAganVtcFRvOiBqdW1wVG8sXG4gICAgICAgIHN0YXJ0OiBzdGFydFxuICAgIH07XG5cbiAgICByZXR1cm4gYXBpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgU3RhdGVIYW5kbGVyOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
