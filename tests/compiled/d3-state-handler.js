define(['exports', 'module'], function (exports, module) {
    // polyfill object assign from MDN
    'use strict';

    if (!Object.assign) {
        Object.defineProperty(Object, 'assign', {
            enumerable: false,
            configurable: true,
            writable: true,
            value: function value(target) {
                'use strict';
                if (target === undefined || target === null) {
                    throw new TypeError('Cannot convert first argument to object');
                }

                var to = Object(target);
                for (var i = 1; i < arguments.length; i++) {
                    var nextSource = arguments[i];
                    if (nextSource === undefined || nextSource === null) {
                        continue;
                    }
                    nextSource = Object(nextSource);

                    var keysArray = Object.keys(nextSource);
                    for (var nextIndex = 0, len = keysArray.length; nextIndex < len; nextIndex++) {
                        var nextKey = keysArray[nextIndex];
                        var desc = Object.getOwnPropertyDescriptor(nextSource, nextKey);
                        if (desc !== undefined && desc.enumerable) {
                            to[nextKey] = nextSource[nextKey];
                        }
                    }
                }
                return to;
            }
        });
    }

    // Stolen from http://stackoverflow.com/a/8668283
    function arrayObjectIndexOf(myArray, searchTerm, property) {
        for (var i = 0, len = myArray.length; i < len; i++) {
            if (myArray[i][property] === searchTerm) return i;
        }
        return -1;
    }

    var StateHandler = function StateHandler(Window, opts) {

        /*
         * Private vars
         */

        // Used to hold states and keep track of which state the user is currently interacting with
        var currentIndex = 0;
        var states = [];

        // This function just lets data flow through it unmutated. Used as a filler for missing methods on state objects
        var substitute = function substitute(data) {
            return data;
        };

        var options = opts || {
            loop: false, // Whether last state should hook into first state and vice versa
            init: substitute, // Function to run before calling the first state
            jumpState: {}, // Contract states must adhere to when returning from jumpOut
            data: {}, // Object passed between states. Every method on a state receives and returns a data object
            load: substitute // Function to be called when a user loads a non-first state from a URL. This function
            // receives data as a parameter and should return an object that is equal to jumpState.
        };

        // For easy reference and so that const is enforced by babel
        var jumpState = options.jumpState;

        // For easy reference
        var data = options.data;

        // When states register, their methods are stored in here so that they are simpler and can be added to html pushState
        var methodRegister = {};

        /*
         * Private Methods
         */
        var registerState = function registerState(state) {

            var avail = !methodRegister[state.name];
            if (!avail) throw new Error('State ' + state.name + ' already exists!');

            methodRegister[state.name] = {
                render: state.render,
                fromNext: state.fromNext || substitute,
                fromPrev: state.fromPrev || substitute,
                toNext: state.toNext || substitute,
                toPrev: state.toPrev || substitute,
                jumpOut: state.jumpOut || substitute,
                jumpIn: state.jumpIn || substitute,
                resize: state.resize || state.render
            };

            if (states.length) states[states.length - 1].next = state.name;

            state = {
                prev: states.length ? states[states.length - 1].name : null,
                name: state.name,
                next: null,
                url: '#' + state.name // Redundant for now but saving for possible use later
            };

            states.push(state);

            return state;
        };

        var resize = function resize() {
            var xData = Object.assign({}, data);
            xData = methodRegister[states[currentIndex].name].resize(xData);
            data = Object.assign({}, data, xData);
        };

        /*
         * Public Methods
         */

        var add = function add(state) {
            state.name = state.name || String(states.length);
            state = registerState(state);
            if (states.length === 1) Window.history.pushState(state, state.name, '#' + state.name);
        };

        var currentState = function currentState() {
            return states[currentIndex];
        };

        var remove = function remove(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            if (index > -1) array.splice(index, 1);
        };

        var loadState = function loadState(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            var targetState = states[index];

            if (index > -1) {
                var xData = options.load(Object.assign({}, data));

                // TODO: check xData against jumpState

                // Call transition methods
                xData = methodRegister[targetState.name].jumpIn(Object.assign({}, jumpState));
                xData = methodRegister[targetState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = index;
                Window.history.pushState(targetState, targetState.name, '#' + targetState.name);
            } else {
                throw new Error('State ' + name + ' does not exist');
            }
        };

        var jumpTo = function jumpTo(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            var currentState = states[currentIndex];
            var targetState = states[index];

            if (index > -1) {
                var xData = Object.assign({}, data);
                xData = methodRegister[currentState.name].jumpOut(xData);

                // TODO: check xData against jumpState

                // Call transition methods
                xData = methodRegister[targetState.name].jumpIn(Object.assign({}, jumpState));
                xData = methodRegister[targetState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = index;
                Window.history.pushState(targetState, targetState.name, '#' + targetState.name);
            } else {
                throw new Error('State ' + name + ' does not exist');
            }
        };

        var next = function next() {
            var thisState = states[currentIndex];
            var nextStateName = thisState.next;

            if (nextStateName) {
                var nextState = states[arrayObjectIndexOf(states, nextStateName, 'name')];
                var xData = Object.assign({}, data);

                // Call transition methods
                xData = methodRegister[thisState.name].toNext(xData);
                xData = methodRegister[nextState.name].fromPrev(xData);
                xData = methodRegister[nextState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = currentIndex + 1 < states.length ? currentIndex + 1 : 0;
                Window.history.pushState(nextState, nextState.name, '#' + nextState.name);
            } else {
                throw new Error('No state after current state (' + JSON.stringify(thisState) + ')');
            }
        };

        var prev = function prev() {
            var thisState = states[currentIndex];
            var prevStateName = thisState.prev;

            if (prevStateName) {
                var prevState = states[arrayObjectIndexOf(states, prevStateName, 'name')];
                var xData = Object.assign({}, data);

                // Cal transition methods
                xData = methodRegister[thisState.name].toPrev(xData);
                xData = methodRegister[prevState.name].fromNext(xData);
                xData = methodRegister[prevState.name].render(xData);

                // Clean up
                data = Object.assign({}, data, xData);
                currentIndex = currentIndex - 1 >= 0 ? currentIndex - 1 : states.length - 1;
                Window.history.pushState(prevState, prevState.name, '#' + prevState.name);
            } else {
                throw new Error('No state before current state (' + JSON.stringify(thisState) + ')');
            }
        };

        var start = function start(fn) {
            // Set up listeners for popState and resize
            Window.addEventListener('popstate', function (e) {
                if (!Window.history) {
                    var xData = Object.assign({}, data);
                    xData = !fn ? options.init(xData) : fn(xData);
                    xData = methodRegister[states[0].name].render(xData);
                    data = Object.assign({}, data, xData);
                    Window.history.pushState(states[0], states[0].name, '#' + states[0].name);
                } else {
                    var index = arrayObjectIndexOf(states, Window.location.hash.slice(1), 'name');
                    Window.history.pushState(states[index], states[index].name, '#' + states[index].name);
                    jumpTo(Window.location.hash.slice(1));
                }
            });
            Window.addEventListener('resize', function (e) {
                resize();
            });

            // Bootstrap application
            if (!Window.location.hash || Window.location.hash.slice(1) === states[0].name) {
                var xData = Object.assign({}, data);
                xData = !fn ? options.init(xData) : fn(xData);
                xData = methodRegister[states[0].name].render(xData);
                data = Object.assign({}, data, xData);
                Window.history.pushState(states[0], states[0].name, '#' + states[0].name);
            } else {
                var index = arrayObjectIndexOf(states, Window.location.hash.slice(1), 'name');
                Window.history.pushState(states[index], states[index].name, '#' + states[index].name);
                jumpTo(Window.location.hash.slice(1));
            }
        };

        var api = {
            next: next,
            add: add,
            currentState: currentState,
            prev: prev,
            remove: remove,
            load: loadState,
            jumpTo: jumpTo,
            start: start
        };

        return api;
    };

    module.exports = StateHandler;
});
//# sourceMappingURL=data:application/json;base64,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QU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3pDO1NBR0osQ0FBQzs7QUFFRixZQUFJLEdBQUcsR0FBRztBQUNOLGdCQUFJLEVBQUUsSUFBSTtBQUNWLGVBQUcsRUFBRSxHQUFHO0FBQ1Isd0JBQVksRUFBRSxZQUFZO0FBQzFCLGdCQUFJLEVBQUUsSUFBSTtBQUNWLGtCQUFNLEVBQUUsTUFBTTtBQUNkLGdCQUFJLEVBQUUsU0FBUztBQUNmLGtCQUFNLEVBQUUsTUFBTTtBQUNkLGlCQUFLLEVBQUUsS0FBSztTQUNmLENBQUM7O0FBRUYsZUFBTyxHQUFHLENBQUM7S0FDZCxDQUFDOztxQkFFYSxZQUFZIiwiZmlsZSI6ImQzLXN0YXRlLWhhbmRsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBwb2x5ZmlsbCBvYmplY3QgYXNzaWduIGZyb20gTUROXG5pZiAoIU9iamVjdC5hc3NpZ24pIHtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoT2JqZWN0LCAnYXNzaWduJywge1xuICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKHRhcmdldCkge1xuICAgICAgICAgICAgJ3VzZSBzdHJpY3QnO1xuICAgICAgICAgICAgaWYgKHRhcmdldCA9PT0gdW5kZWZpbmVkIHx8IHRhcmdldCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0IGZpcnN0IGFyZ3VtZW50IHRvIG9iamVjdCcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgdG8gPSBPYmplY3QodGFyZ2V0KTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5leHRTb3VyY2UgPSBhcmd1bWVudHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKG5leHRTb3VyY2UgPT09IHVuZGVmaW5lZCB8fCBuZXh0U291cmNlID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZXh0U291cmNlID0gT2JqZWN0KG5leHRTb3VyY2UpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGtleXNBcnJheSA9IE9iamVjdC5rZXlzKG5leHRTb3VyY2UpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIG5leHRJbmRleCA9IDAsIGxlbiA9IGtleXNBcnJheS5sZW5ndGg7IG5leHRJbmRleCA8IGxlbjsgbmV4dEluZGV4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHRLZXkgPSBrZXlzQXJyYXlbbmV4dEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5leHRTb3VyY2UsIG5leHRLZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGVzYyAhPT0gdW5kZWZpbmVkICYmIGRlc2MuZW51bWVyYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9bbmV4dEtleV0gPSBuZXh0U291cmNlW25leHRLZXldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRvO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbi8vIFN0b2xlbiBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzg2NjgyODNcbmZ1bmN0aW9uIGFycmF5T2JqZWN0SW5kZXhPZihteUFycmF5LCBzZWFyY2hUZXJtLCBwcm9wZXJ0eSkge1xuICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IG15QXJyYXkubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgaWYgKG15QXJyYXlbaV1bcHJvcGVydHldID09PSBzZWFyY2hUZXJtKSByZXR1cm4gaTtcbiAgICB9XG4gICAgcmV0dXJuIC0xO1xufVxuXG5jb25zdCBTdGF0ZUhhbmRsZXIgPSBmdW5jdGlvbiBTdGF0ZUhhbmRsZXIoV2luZG93LG9wdHMpIHtcblxuICAgIC8qXG4gICAgICogUHJpdmF0ZSB2YXJzXG4gICAgICovXG5cbiAgICAvLyBVc2VkIHRvIGhvbGQgc3RhdGVzIGFuZCBrZWVwIHRyYWNrIG9mIHdoaWNoIHN0YXRlIHRoZSB1c2VyIGlzIGN1cnJlbnRseSBpbnRlcmFjdGluZyB3aXRoXG4gICAgbGV0IGN1cnJlbnRJbmRleCA9IDA7XG4gICAgbGV0IHN0YXRlcyA9IFtdO1xuXG4gICAgLy8gVGhpcyBmdW5jdGlvbiBqdXN0IGxldHMgZGF0YSBmbG93IHRocm91Z2ggaXQgdW5tdXRhdGVkLiBVc2VkIGFzIGEgZmlsbGVyIGZvciBtaXNzaW5nIG1ldGhvZHMgb24gc3RhdGUgb2JqZWN0c1xuICAgIGNvbnN0IHN1YnN0aXR1dGUgPSBmdW5jdGlvbihkYXRhKSB7cmV0dXJuIGRhdGF9O1xuXG4gICAgbGV0IG9wdGlvbnMgPSBvcHRzIHx8IHtcbiAgICAgICAgICAgIGxvb3A6IGZhbHNlLCAgICAgICAgLy8gV2hldGhlciBsYXN0IHN0YXRlIHNob3VsZCBob29rIGludG8gZmlyc3Qgc3RhdGUgYW5kIHZpY2UgdmVyc2FcbiAgICAgICAgICAgIGluaXQ6IHN1YnN0aXR1dGUsICAgLy8gRnVuY3Rpb24gdG8gcnVuIGJlZm9yZSBjYWxsaW5nIHRoZSBmaXJzdCBzdGF0ZVxuICAgICAgICAgICAganVtcFN0YXRlOiB7fSwgICAgICAvLyBDb250cmFjdCBzdGF0ZXMgbXVzdCBhZGhlcmUgdG8gd2hlbiByZXR1cm5pbmcgZnJvbSBqdW1wT3V0XG4gICAgICAgICAgICBkYXRhOiB7fSwgICAgICAgICAgIC8vIE9iamVjdCBwYXNzZWQgYmV0d2VlbiBzdGF0ZXMuIEV2ZXJ5IG1ldGhvZCBvbiBhIHN0YXRlIHJlY2VpdmVzIGFuZCByZXR1cm5zIGEgZGF0YSBvYmplY3RcbiAgICAgICAgICAgIGxvYWQ6IHN1YnN0aXR1dGUgICAgLy8gRnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gYSB1c2VyIGxvYWRzIGEgbm9uLWZpcnN0IHN0YXRlIGZyb20gYSBVUkwuIFRoaXMgZnVuY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlY2VpdmVzIGRhdGEgYXMgYSBwYXJhbWV0ZXIgYW5kIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgaXMgZXF1YWwgdG8ganVtcFN0YXRlLlxuICAgICAgICB9O1xuXG4gICAgLy8gRm9yIGVhc3kgcmVmZXJlbmNlIGFuZCBzbyB0aGF0IGNvbnN0IGlzIGVuZm9yY2VkIGJ5IGJhYmVsXG4gICAgY29uc3QganVtcFN0YXRlID0gb3B0aW9ucy5qdW1wU3RhdGU7XG5cbiAgICAvLyBGb3IgZWFzeSByZWZlcmVuY2VcbiAgICBsZXQgZGF0YSA9IG9wdGlvbnMuZGF0YTtcblxuICAgIC8vIFdoZW4gc3RhdGVzIHJlZ2lzdGVyLCB0aGVpciBtZXRob2RzIGFyZSBzdG9yZWQgaW4gaGVyZSBzbyB0aGF0IHRoZXkgYXJlIHNpbXBsZXIgYW5kIGNhbiBiZSBhZGRlZCB0byBodG1sIHB1c2hTdGF0ZVxuICAgIGxldCBtZXRob2RSZWdpc3RlciA9IHt9O1xuXG4gICAgLypcbiAgICAgKiBQcml2YXRlIE1ldGhvZHNcbiAgICAgKi9cbiAgICBsZXQgcmVnaXN0ZXJTdGF0ZSA9IChzdGF0ZSkgPT4ge1xuXG4gICAgICAgIGxldCBhdmFpbCA9ICFtZXRob2RSZWdpc3RlcltzdGF0ZS5uYW1lXTtcbiAgICAgICAgaWYgKCFhdmFpbCkgdGhyb3cgbmV3IEVycm9yKGBTdGF0ZSAke3N0YXRlLm5hbWV9IGFscmVhZHkgZXhpc3RzIWApO1xuXG4gICAgICAgIG1ldGhvZFJlZ2lzdGVyW3N0YXRlLm5hbWVdID0ge1xuICAgICAgICAgICAgcmVuZGVyOiBzdGF0ZS5yZW5kZXIsXG4gICAgICAgICAgICBmcm9tTmV4dDogc3RhdGUuZnJvbU5leHQgfHwgc3Vic3RpdHV0ZSxcbiAgICAgICAgICAgIGZyb21QcmV2OiBzdGF0ZS5mcm9tUHJldiB8fCBzdWJzdGl0dXRlLFxuICAgICAgICAgICAgdG9OZXh0OiBzdGF0ZS50b05leHQgfHwgc3Vic3RpdHV0ZSxcbiAgICAgICAgICAgIHRvUHJldjogc3RhdGUudG9QcmV2IHx8IHN1YnN0aXR1dGUsXG4gICAgICAgICAgICBqdW1wT3V0OiBzdGF0ZS5qdW1wT3V0IHx8IHN1YnN0aXR1dGUsXG4gICAgICAgICAgICBqdW1wSW46IHN0YXRlLmp1bXBJbiB8fCBzdWJzdGl0dXRlLFxuICAgICAgICAgICAgcmVzaXplOiBzdGF0ZS5yZXNpemUgfHwgc3RhdGUucmVuZGVyXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHN0YXRlcy5sZW5ndGgpIHN0YXRlc1tzdGF0ZXMubGVuZ3RoIC0gMV0ubmV4dCA9IHN0YXRlLm5hbWU7XG5cbiAgICAgICAgc3RhdGUgPSB7XG4gICAgICAgICAgICBwcmV2OiBzdGF0ZXMubGVuZ3RoID8gc3RhdGVzW3N0YXRlcy5sZW5ndGggLSAxXS5uYW1lOiBudWxsLFxuICAgICAgICAgICAgbmFtZTogc3RhdGUubmFtZSxcbiAgICAgICAgICAgIG5leHQ6IG51bGwsXG4gICAgICAgICAgICB1cmw6IGAjJHtzdGF0ZS5uYW1lfWAgLy8gUmVkdW5kYW50IGZvciBub3cgYnV0IHNhdmluZyBmb3IgcG9zc2libGUgdXNlIGxhdGVyXG4gICAgICAgIH07XG5cbiAgICAgICAgc3RhdGVzLnB1c2goc3RhdGUpO1xuXG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9O1xuXG4gICAgbGV0IHJlc2l6ZSA9ICgpID0+IHtcbiAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcbiAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3RlcltzdGF0ZXNbY3VycmVudEluZGV4XS5uYW1lXS5yZXNpemUoeERhdGEpO1xuICAgICAgICBkYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhLHhEYXRhKTtcbiAgICB9O1xuXG4gICAgLypcbiAgICAgKiBQdWJsaWMgTWV0aG9kc1xuICAgICAqL1xuXG4gICAgbGV0IGFkZCA9IChzdGF0ZSkgPT4ge1xuICAgICAgICBzdGF0ZS5uYW1lID0gc3RhdGUubmFtZSB8fCBTdHJpbmcoc3RhdGVzLmxlbmd0aCk7XG4gICAgICAgIHN0YXRlID0gcmVnaXN0ZXJTdGF0ZShzdGF0ZSk7XG4gICAgICAgIGlmIChzdGF0ZXMubGVuZ3RoID09PSAxKSBXaW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUoc3RhdGUsc3RhdGUubmFtZSxgIyR7c3RhdGUubmFtZX1gKVxuICAgIH07XG5cbiAgICBsZXQgY3VycmVudFN0YXRlID0gKCkgPT4ge1xuICAgICAgICByZXR1cm4gc3RhdGVzW2N1cnJlbnRJbmRleF07XG4gICAgfTtcblxuICAgIGxldCByZW1vdmUgPSAobmFtZSkgPT4ge1xuICAgICAgICBsZXQgaW5kZXggPSBhcnJheU9iamVjdEluZGV4T2Yoc3RhdGVzLG5hbWUsJ25hbWUnKTtcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgfTtcblxuICAgIGxldCBsb2FkU3RhdGUgPSAobmFtZSkgPT4ge1xuICAgICAgICBsZXQgaW5kZXggPSBhcnJheU9iamVjdEluZGV4T2Yoc3RhdGVzLG5hbWUsJ25hbWUnKTtcbiAgICAgICAgbGV0IHRhcmdldFN0YXRlID0gc3RhdGVzW2luZGV4XTtcblxuICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgbGV0IHhEYXRhID0gb3B0aW9ucy5sb2FkKE9iamVjdC5hc3NpZ24oe30sZGF0YSkpO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiBjaGVjayB4RGF0YSBhZ2FpbnN0IGp1bXBTdGF0ZVxuXG4gICAgICAgICAgICAvLyBDYWxsIHRyYW5zaXRpb24gbWV0aG9kc1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3Rlclt0YXJnZXRTdGF0ZS5uYW1lXS5qdW1wSW4oT2JqZWN0LmFzc2lnbih7fSxqdW1wU3RhdGUpKTtcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbdGFyZ2V0U3RhdGUubmFtZV0ucmVuZGVyKHhEYXRhKTtcblxuICAgICAgICAgICAgLy8gQ2xlYW4gdXBcbiAgICAgICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgICAgICAgICAgY3VycmVudEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICBXaW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUodGFyZ2V0U3RhdGUsdGFyZ2V0U3RhdGUubmFtZSxgIyR7dGFyZ2V0U3RhdGUubmFtZX1gKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGF0ZSAke25hbWV9IGRvZXMgbm90IGV4aXN0YClcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBsZXQganVtcFRvID0gKG5hbWUpID0+IHtcbiAgICAgICAgbGV0IGluZGV4ID0gYXJyYXlPYmplY3RJbmRleE9mKHN0YXRlcyxuYW1lLCduYW1lJyk7XG4gICAgICAgIGxldCBjdXJyZW50U3RhdGUgPSBzdGF0ZXNbY3VycmVudEluZGV4XTtcbiAgICAgICAgbGV0IHRhcmdldFN0YXRlID0gc3RhdGVzW2luZGV4XTtcblxuICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbY3VycmVudFN0YXRlLm5hbWVdLmp1bXBPdXQoeERhdGEpO1xuXG4gICAgICAgICAgICAvLyBUT0RPOiBjaGVjayB4RGF0YSBhZ2FpbnN0IGp1bXBTdGF0ZVxuXG5cbiAgICAgICAgICAgIC8vIENhbGwgdHJhbnNpdGlvbiBtZXRob2RzXG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3RhcmdldFN0YXRlLm5hbWVdLmp1bXBJbihPYmplY3QuYXNzaWduKHt9LGp1bXBTdGF0ZSkpO1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3Rlclt0YXJnZXRTdGF0ZS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuXG4gICAgICAgICAgICAvLyBDbGVhbiB1cFxuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSh0YXJnZXRTdGF0ZSx0YXJnZXRTdGF0ZS5uYW1lLGAjJHt0YXJnZXRTdGF0ZS5uYW1lfWApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0YXRlICR7bmFtZX0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBsZXQgbmV4dCA9ICgpID0+IHtcbiAgICAgICAgbGV0IHRoaXNTdGF0ZSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdO1xuICAgICAgICBsZXQgbmV4dFN0YXRlTmFtZSA9IHRoaXNTdGF0ZS5uZXh0O1xuXG4gICAgICAgIGlmIChuZXh0U3RhdGVOYW1lKSB7XG4gICAgICAgICAgICBsZXQgbmV4dFN0YXRlID0gc3RhdGVzW2FycmF5T2JqZWN0SW5kZXhPZihzdGF0ZXMsbmV4dFN0YXRlTmFtZSwnbmFtZScpXTtcbiAgICAgICAgICAgIGxldCB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG5cbiAgICAgICAgICAgIC8vIENhbGwgdHJhbnNpdGlvbiBtZXRob2RzXG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3RoaXNTdGF0ZS5uYW1lXS50b05leHQoeERhdGEpO1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3RlcltuZXh0U3RhdGUubmFtZV0uZnJvbVByZXYoeERhdGEpO1xuICAgICAgICAgICAgeERhdGEgPSBtZXRob2RSZWdpc3RlcltuZXh0U3RhdGUubmFtZV0ucmVuZGVyKHhEYXRhKTtcblxuICAgICAgICAgICAgLy8gQ2xlYW4gdXBcbiAgICAgICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgICAgICAgICAgY3VycmVudEluZGV4ID0gKGN1cnJlbnRJbmRleCArIDEgPCBzdGF0ZXMubGVuZ3RoKSA/IGN1cnJlbnRJbmRleCArIDEgOiAwO1xuICAgICAgICAgICAgV2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKG5leHRTdGF0ZSxuZXh0U3RhdGUubmFtZSxgIyR7bmV4dFN0YXRlLm5hbWV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHN0YXRlIGFmdGVyIGN1cnJlbnQgc3RhdGUgKCR7SlNPTi5zdHJpbmdpZnkodGhpc1N0YXRlKX0pYClcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBsZXQgcHJldiA9ICgpID0+IHtcbiAgICAgICAgbGV0IHRoaXNTdGF0ZSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdO1xuICAgICAgICBsZXQgcHJldlN0YXRlTmFtZSA9IHRoaXNTdGF0ZS5wcmV2O1xuXG4gICAgICAgIGlmIChwcmV2U3RhdGVOYW1lKSB7XG4gICAgICAgICAgICBsZXQgcHJldlN0YXRlID0gc3RhdGVzW2FycmF5T2JqZWN0SW5kZXhPZihzdGF0ZXMscHJldlN0YXRlTmFtZSwnbmFtZScpXTtcbiAgICAgICAgICAgIGxldCB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG5cbiAgICAgICAgICAgIC8vIENhbCB0cmFuc2l0aW9uIG1ldGhvZHNcbiAgICAgICAgICAgIHhEYXRhID0gbWV0aG9kUmVnaXN0ZXJbdGhpc1N0YXRlLm5hbWVdLnRvUHJldih4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3ByZXZTdGF0ZS5uYW1lXS5mcm9tTmV4dCh4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3ByZXZTdGF0ZS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuXG4gICAgICAgICAgICAvLyBDbGVhbiB1cFxuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSAoY3VycmVudEluZGV4IC0gMSA+PSAwKSA/IGN1cnJlbnRJbmRleCAtIDEgOiBzdGF0ZXMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShwcmV2U3RhdGUscHJldlN0YXRlLm5hbWUsYCMke3ByZXZTdGF0ZS5uYW1lfWApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBzdGF0ZSBiZWZvcmUgY3VycmVudCBzdGF0ZSAoJHtKU09OLnN0cmluZ2lmeSh0aGlzU3RhdGUpfSlgKVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBzdGFydCA9IChmbikgPT4ge1xuICAgICAgICAvLyBTZXQgdXAgbGlzdGVuZXJzIGZvciBwb3BTdGF0ZSBhbmQgcmVzaXplXG4gICAgICAgIFdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsKGUpID0+IHtcbiAgICAgICAgICAgIGlmICghV2luZG93Lmhpc3RvcnkpIHtcbiAgICAgICAgICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICAgICAgICAgIHhEYXRhID0gIWZuID8gb3B0aW9ucy5pbml0KHhEYXRhKSA6IGZuKHhEYXRhKTtcbiAgICAgICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3N0YXRlc1swXS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuICAgICAgICAgICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgICAgICAgICAgICAgIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZXNbMF0sIHN0YXRlc1swXS5uYW1lLGAjJHtzdGF0ZXNbMF0ubmFtZX1gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gYXJyYXlPYmplY3RJbmRleE9mKHN0YXRlcyxXaW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSwnbmFtZScpO1xuICAgICAgICAgICAgICAgIFdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZXNbaW5kZXhdLCBzdGF0ZXNbaW5kZXhdLm5hbWUsYCMke3N0YXRlc1tpbmRleF0ubmFtZX1gKTtcbiAgICAgICAgICAgICAgICBqdW1wVG8oV2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgV2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsKGUpID0+IHtcbiAgICAgICAgICAgIHJlc2l6ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBCb290c3RyYXAgYXBwbGljYXRpb25cbiAgICAgICAgaWYgKCFXaW5kb3cubG9jYXRpb24uaGFzaCB8fCBXaW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSA9PT0gc3RhdGVzWzBdLm5hbWUpIHtcbiAgICAgICAgICAgIGxldCB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9ICFmbiA/IG9wdGlvbnMuaW5pdCh4RGF0YSkgOiBmbih4RGF0YSk7XG4gICAgICAgICAgICB4RGF0YSA9IG1ldGhvZFJlZ2lzdGVyW3N0YXRlc1swXS5uYW1lXS5yZW5kZXIoeERhdGEpO1xuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgICAgICBXaW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUoc3RhdGVzWzBdLCBzdGF0ZXNbMF0ubmFtZSxgIyR7c3RhdGVzWzBdLm5hbWV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgaW5kZXggPSBhcnJheU9iamVjdEluZGV4T2Yoc3RhdGVzLFdpbmRvdy5sb2NhdGlvbi5oYXNoLnNsaWNlKDEpLCduYW1lJyk7XG4gICAgICAgICAgICBXaW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUoc3RhdGVzW2luZGV4XSwgc3RhdGVzW2luZGV4XS5uYW1lLGAjJHtzdGF0ZXNbaW5kZXhdLm5hbWV9YCk7XG4gICAgICAgICAgICBqdW1wVG8oV2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkpO1xuICAgICAgICB9XG5cblxuICAgIH07XG5cbiAgICBsZXQgYXBpID0ge1xuICAgICAgICBuZXh0OiBuZXh0LFxuICAgICAgICBhZGQ6IGFkZCxcbiAgICAgICAgY3VycmVudFN0YXRlOiBjdXJyZW50U3RhdGUsXG4gICAgICAgIHByZXY6IHByZXYsXG4gICAgICAgIHJlbW92ZTogcmVtb3ZlLFxuICAgICAgICBsb2FkOiBsb2FkU3RhdGUsXG4gICAgICAgIGp1bXBUbzoganVtcFRvLFxuICAgICAgICBzdGFydDogc3RhcnRcbiAgICB9O1xuXG4gICAgcmV0dXJuIGFwaTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFN0YXRlSGFuZGxlcjsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
