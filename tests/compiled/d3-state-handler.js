define(['exports', 'module', 'urlHandler'], function (exports, module, _urlHandler) {
    'use strict';

    // polyfill object assign from MDN
    if (!Object.assign) {
        Object.defineProperty(Object, 'assign', {
            enumerable: false,
            configurable: true,
            writable: true,
            value: function value(target) {
                'use strict';
                if (target === undefined || target === null) {
                    throw new TypeError('Cannot convert first argument to object');
                }

                var to = Object(target);
                for (var i = 1; i < arguments.length; i++) {
                    var nextSource = arguments[i];
                    if (nextSource === undefined || nextSource === null) {
                        continue;
                    }
                    nextSource = Object(nextSource);

                    var keysArray = Object.keys(nextSource);
                    for (var nextIndex = 0, len = keysArray.length; nextIndex < len; nextIndex++) {
                        var nextKey = keysArray[nextIndex];
                        var desc = Object.getOwnPropertyDescriptor(nextSource, nextKey);
                        if (desc !== undefined && desc.enumerable) {
                            to[nextKey] = nextSource[nextKey];
                        }
                    }
                }
                return to;
            }
        });
    }

    // Stolen from http://stackoverflow.com/a/8668283
    function arrayObjectIndexOf(myArray, searchTerm, property) {
        for (var i = 0, len = myArray.length; i < len; i++) {
            if (myArray[i][property] === searchTerm) return i;
        }
        return -1;
    }

    // Error handling
    function FinalState(message) {
        "use strict";
        this.name = 'FinalStateError';
        this.message = message || "There are no more states to advance to";
        this.stack = new Error().stack;
    }
    FinalState.prototype = Object.create(Error.prototype);
    FinalState.prototype.constructor = FinalState;

    function FirstState(message) {
        "use strict";
        this.name = 'FirstStateError';
        this.message = message || "There are no states before this one";
        this.stack = new Error().stack;
    }
    FirstState.prototype = Object.create(Error.prototype);
    FirstState.prototype.constructor = FirstState;

    var StateHandler = function StateHandler(opts) {
        "use strict";

        var _this = this;

        var currentIndex = 0;
        var states = [];
        var options = opts || {
            loop: false // specifies whether states should loop from end - beginning and vice versa
        };
        var data = options.data || {};
        var jumpState = options.jumpState || {};

        var currentState = function currentState() {
            return states[currentIndex];
        };

        var start = function start() {
            var xData = Object.assign({}, data);
            xData = states[currentIndex].render(xData);
            data = Object.assign({}, data, xData);
        };

        var add = function add(state) {
            var index = states.length;
            state['__index'] = index;
            if (!state.name) state.name = String(index);
            if (typeof state.render !== 'function') throw new Error('States require a render method');
            if (typeof state.resize !== 'function') state.resize = state.render;

            states.push(state);
            return _this;
        };

        var remove = function remove(name) {
            var index = arrayObjectIndexOf(states, name, 'name');

            if (index > -1) {
                array.splice(index, 1);
            }

            return _this;
        };

        var jumpTo = function jumpTo(name) {
            var index = arrayObjectIndexOf(states, name, 'name');
            var xData = Object.assign({}, data);
            if (index > -1) {
                try {
                    xData = states[currentIndex].jumpOut(xData);
                } catch (e) {
                    if (!e.name === 'TypeError') throw new Error(e);
                }

                // Here we should test xData against jumpState

                currentIndex = index;
                try {
                    xData = states[currentIndex].jumpIn(xData);
                } catch (e) {
                    if (!e.name === 'TypeError') throw new Error(e);
                }

                // Again, we should test xData against jumpState

                xData = states[currentIndex].render(xData);
                data = Object.assign({}, data, xData);
            } else {
                throw new Error('State ' + name + ' does not exist');
            }
        };

        var next = function next() {
            "use strict";
            var xData = Object.assign({}, data);
            // Call nextOut on the current state if it exists
            if (typeof states[currentIndex].nextOut !== 'undefined') xData = Object.assign({}, states[currentIndex].nextOut(xData));

            // Set the current state to the next index. Loop if specified.
            if (currentIndex + 1 < states.length) {
                currentIndex += 1;
            } else if (options.loop) {
                currentIndex = 0;
            } else {
                throw new FinalState();
            }

            // Call nextIn on the new current state
            if (typeof states[currentIndex].nextIn !== 'undefined') xData = Object.assign({}, states[currentIndex].nextIn(xData));

            // Call render on the new current state
            if (typeof states[currentIndex].render !== 'undefined') xData = Object.assign({}, states[currentIndex].render(xData));
            data = Object.assign({}, data, xData);
            return _this;
        };

        var prev = function prev() {
            "use strict";
            var xData = Object.assign({}, data);
            // Call prevOut on the current state if it exists
            if (typeof states[currentIndex].prevOut !== 'undefined') xData = Object.assign({}, states[currentIndex].prevOut(xData));

            // Set the current state to the previous index. Loop if specified.
            if (currentIndex - 1 >= 0) {
                currentIndex -= 1;
            } else if (options.loop) {
                currentIndex = states.length - 1;
            } else {
                throw new FirstState();
            }

            // Call prevIn on the new current state
            if (typeof states[currentIndex].prevIn !== 'undefined') xData = Object.assign({}, states[currentIndex].prevIn(xData));

            // Call render on new current state;
            if (typeof states[currentIndex].render !== 'undefined') xData = Object.assign({}, states[currentIndex].render(xData));
            data = Object.assign({}, data, xData);
            return _this;
        };

        var resize = function resize() {
            var xData = Object.assign({}, data);
            xData = states[currentIndex].resize(xData);
            data = Object.assign({}, data, xData);
        };

        return {
            next: next,
            add: add,
            currentState: currentState,
            prev: prev,
            remove: remove,
            resize: resize,
            jumpTo: jumpTo,
            start: start
        };
    };

    module.exports = StateHandler;
});
//# sourceMappingURL=data:application/json;base64,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Q2Qsa0JBQU0sRUFBRSxNQUFNO0FBQ2Qsa0JBQU0sRUFBRSxNQUFNO0FBQ2QsaUJBQUssRUFBRSxLQUFLO1NBQ2YsQ0FBQTtLQUNKLENBQUM7O3FCQUVhLFlBQVkiLCJmaWxlIjoiZDMtc3RhdGUtaGFuZGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAndXJsSGFuZGxlcic7XG5cbi8vIHBvbHlmaWxsIG9iamVjdCBhc3NpZ24gZnJvbSBNRE5cbmlmICghT2JqZWN0LmFzc2lnbikge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPYmplY3QsICdhc3NpZ24nLCB7XG4gICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICB2YWx1ZTogZnVuY3Rpb24odGFyZ2V0KSB7XG4gICAgICAgICAgICAndXNlIHN0cmljdCc7XG4gICAgICAgICAgICBpZiAodGFyZ2V0ID09PSB1bmRlZmluZWQgfHwgdGFyZ2V0ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgZmlyc3QgYXJndW1lbnQgdG8gb2JqZWN0Jyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciB0byA9IE9iamVjdCh0YXJnZXQpO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dFNvdXJjZSA9IGFyZ3VtZW50c1tpXTtcbiAgICAgICAgICAgICAgICBpZiAobmV4dFNvdXJjZSA9PT0gdW5kZWZpbmVkIHx8IG5leHRTb3VyY2UgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5leHRTb3VyY2UgPSBPYmplY3QobmV4dFNvdXJjZSk7XG5cbiAgICAgICAgICAgICAgICB2YXIga2V5c0FycmF5ID0gT2JqZWN0LmtleXMobmV4dFNvdXJjZSk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgbmV4dEluZGV4ID0gMCwgbGVuID0ga2V5c0FycmF5Lmxlbmd0aDsgbmV4dEluZGV4IDwgbGVuOyBuZXh0SW5kZXgrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dEtleSA9IGtleXNBcnJheVtuZXh0SW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobmV4dFNvdXJjZSwgbmV4dEtleSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkZXNjICE9PSB1bmRlZmluZWQgJiYgZGVzYy5lbnVtZXJhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b1tuZXh0S2V5XSA9IG5leHRTb3VyY2VbbmV4dEtleV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdG87XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuLy8gU3RvbGVuIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvODY2ODI4M1xuZnVuY3Rpb24gYXJyYXlPYmplY3RJbmRleE9mKG15QXJyYXksIHNlYXJjaFRlcm0sIHByb3BlcnR5KSB7XG4gICAgZm9yKHZhciBpID0gMCwgbGVuID0gbXlBcnJheS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBpZiAobXlBcnJheVtpXVtwcm9wZXJ0eV0gPT09IHNlYXJjaFRlcm0pIHJldHVybiBpO1xuICAgIH1cbiAgICByZXR1cm4gLTE7XG59XG5cbi8vIEVycm9yIGhhbmRsaW5nXG5mdW5jdGlvbiBGaW5hbFN0YXRlKG1lc3NhZ2UpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLm5hbWUgPSAnRmluYWxTdGF0ZUVycm9yJztcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiVGhlcmUgYXJlIG5vIG1vcmUgc3RhdGVzIHRvIGFkdmFuY2UgdG9cIjtcbiAgICB0aGlzLnN0YWNrID0gKG5ldyBFcnJvcigpKS5zdGFjaztcbn1cbkZpbmFsU3RhdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpO1xuRmluYWxTdGF0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGaW5hbFN0YXRlO1xuXG5mdW5jdGlvbiBGaXJzdFN0YXRlKG1lc3NhZ2UpIHtcbiAgICBcInVzZSBzdHJpY3RcIjtcbiAgICB0aGlzLm5hbWUgPSAnRmlyc3RTdGF0ZUVycm9yJztcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiVGhlcmUgYXJlIG5vIHN0YXRlcyBiZWZvcmUgdGhpcyBvbmVcIjtcbiAgICB0aGlzLnN0YWNrID0gKG5ldyBFcnJvcigpKS5zdGFjaztcbn1cbkZpcnN0U3RhdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpO1xuRmlyc3RTdGF0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGaXJzdFN0YXRlO1xuXG5jb25zdCBTdGF0ZUhhbmRsZXIgPSBmdW5jdGlvbiBTdGF0ZUhhbmRsZXIob3B0cykge1xuICAgIFwidXNlIHN0cmljdFwiO1xuICAgIGxldCBjdXJyZW50SW5kZXggPSAwO1xuICAgIGxldCBzdGF0ZXMgPSBbXTtcbiAgICBsZXQgb3B0aW9ucyA9IG9wdHMgfHwge1xuICAgICAgICAgICAgbG9vcDogZmFsc2UgLy8gc3BlY2lmaWVzIHdoZXRoZXIgc3RhdGVzIHNob3VsZCBsb29wIGZyb20gZW5kIC0gYmVnaW5uaW5nIGFuZCB2aWNlIHZlcnNhXG4gICAgICAgIH07XG4gICAgbGV0IGRhdGEgPSBvcHRpb25zLmRhdGEgfHwge307XG4gICAgbGV0IGp1bXBTdGF0ZSA9IG9wdGlvbnMuanVtcFN0YXRlIHx8IHt9O1xuXG4gICAgbGV0IGN1cnJlbnRTdGF0ZSA9ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHN0YXRlc1tjdXJyZW50SW5kZXhdO1xuICAgIH07XG5cbiAgICBsZXQgc3RhcnQgPSAoKSA9PiB7XG4gICAgICAgIGxldCB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSk7XG4gICAgICAgIHhEYXRhID0gc3RhdGVzW2N1cnJlbnRJbmRleF0ucmVuZGVyKHhEYXRhKTtcbiAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgfTtcblxuICAgIGxldCBhZGQgPSAoc3RhdGUpID0+IHtcbiAgICAgICAgbGV0IGluZGV4ID0gc3RhdGVzLmxlbmd0aDtcbiAgICAgICAgc3RhdGVbJ19faW5kZXgnXSA9IGluZGV4O1xuICAgICAgICBpZiAoIXN0YXRlLm5hbWUpIHN0YXRlLm5hbWUgPSBTdHJpbmcoaW5kZXgpO1xuICAgICAgICBpZiAodHlwZW9mIHN0YXRlLnJlbmRlciAhPT0gJ2Z1bmN0aW9uJykgdGhyb3cgbmV3IEVycm9yKCdTdGF0ZXMgcmVxdWlyZSBhIHJlbmRlciBtZXRob2QnKTtcbiAgICAgICAgaWYgKHR5cGVvZiBzdGF0ZS5yZXNpemUgIT09ICdmdW5jdGlvbicpIHN0YXRlLnJlc2l6ZSA9IHN0YXRlLnJlbmRlcjtcblxuICAgICAgICBzdGF0ZXMucHVzaChzdGF0ZSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICBsZXQgcmVtb3ZlID0gKG5hbWUpID0+IHtcbiAgICAgICAgbGV0IGluZGV4ID0gYXJyYXlPYmplY3RJbmRleE9mKHN0YXRlcyxuYW1lLCduYW1lJyk7XG5cbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgbGV0IGp1bXBUbyA9IChuYW1lKSA9PiB7XG4gICAgICAgIGxldCBpbmRleCA9IGFycmF5T2JqZWN0SW5kZXhPZihzdGF0ZXMsbmFtZSwnbmFtZScpO1xuICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB4RGF0YSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdLmp1bXBPdXQoeERhdGEpO1xuICAgICAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFlLm5hbWUgPT09ICdUeXBlRXJyb3InKSB0aHJvdyBuZXcgRXJyb3IoZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEhlcmUgd2Ugc2hvdWxkIHRlc3QgeERhdGEgYWdhaW5zdCBqdW1wU3RhdGVcblxuICAgICAgICAgICAgY3VycmVudEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHhEYXRhID0gc3RhdGVzW2N1cnJlbnRJbmRleF0uanVtcEluKHhEYXRhKTtcbiAgICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgICAgIGlmICghZS5uYW1lID09PSAnVHlwZUVycm9yJykgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBBZ2Fpbiwgd2Ugc2hvdWxkIHRlc3QgeERhdGEgYWdhaW5zdCBqdW1wU3RhdGVcblxuICAgICAgICAgICAgeERhdGEgPSBzdGF0ZXNbY3VycmVudEluZGV4XS5yZW5kZXIoeERhdGEpO1xuICAgICAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0YXRlICR7bmFtZX0gZG9lcyBub3QgZXhpc3RgKVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGxldCBuZXh0ID0gKCkgPT4ge1xuICAgICAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAgICAgbGV0IHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcbiAgICAgICAgLy8gQ2FsbCBuZXh0T3V0IG9uIHRoZSBjdXJyZW50IHN0YXRlIGlmIGl0IGV4aXN0c1xuICAgICAgICBpZiAodHlwZW9mIHN0YXRlc1tjdXJyZW50SW5kZXhdLm5leHRPdXQgIT09ICd1bmRlZmluZWQnKSB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sc3RhdGVzW2N1cnJlbnRJbmRleF0ubmV4dE91dCh4RGF0YSkpO1xuXG4gICAgICAgIC8vIFNldCB0aGUgY3VycmVudCBzdGF0ZSB0byB0aGUgbmV4dCBpbmRleC4gTG9vcCBpZiBzcGVjaWZpZWQuXG4gICAgICAgIGlmIChjdXJyZW50SW5kZXggKyAxIDwgc3RhdGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgY3VycmVudEluZGV4ICs9IDE7XG4gICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5sb29wKSB7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEZpbmFsU3RhdGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENhbGwgbmV4dEluIG9uIHRoZSBuZXcgY3VycmVudCBzdGF0ZVxuICAgICAgICBpZiAodHlwZW9mIHN0YXRlc1tjdXJyZW50SW5kZXhdLm5leHRJbiAhPT0gJ3VuZGVmaW5lZCcpIHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxzdGF0ZXNbY3VycmVudEluZGV4XS5uZXh0SW4oeERhdGEpKTtcblxuICAgICAgICAvLyBDYWxsIHJlbmRlciBvbiB0aGUgbmV3IGN1cnJlbnQgc3RhdGVcbiAgICAgICAgaWYgKHR5cGVvZiBzdGF0ZXNbY3VycmVudEluZGV4XS5yZW5kZXIgIT09ICd1bmRlZmluZWQnKSB4RGF0YSA9IE9iamVjdC5hc3NpZ24oe30sc3RhdGVzW2N1cnJlbnRJbmRleF0ucmVuZGVyKHhEYXRhKSk7XG4gICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgbGV0IHByZXYgPSAoKSA9PiB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICAvLyBDYWxsIHByZXZPdXQgb24gdGhlIGN1cnJlbnQgc3RhdGUgaWYgaXQgZXhpc3RzXG4gICAgICAgIGlmICh0eXBlb2Ygc3RhdGVzW2N1cnJlbnRJbmRleF0ucHJldk91dCAhPT0gJ3VuZGVmaW5lZCcpIHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxzdGF0ZXNbY3VycmVudEluZGV4XS5wcmV2T3V0KHhEYXRhKSk7XG5cbiAgICAgICAgLy8gU2V0IHRoZSBjdXJyZW50IHN0YXRlIHRvIHRoZSBwcmV2aW91cyBpbmRleC4gTG9vcCBpZiBzcGVjaWZpZWQuXG4gICAgICAgIGlmIChjdXJyZW50SW5kZXggLSAxID49IDApIHtcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleCAtPSAxO1xuICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMubG9vcCkge1xuICAgICAgICAgICAgY3VycmVudEluZGV4ID0gc3RhdGVzLmxlbmd0aCAtIDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRmlyc3RTdGF0ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2FsbCBwcmV2SW4gb24gdGhlIG5ldyBjdXJyZW50IHN0YXRlXG4gICAgICAgIGlmICh0eXBlb2Ygc3RhdGVzW2N1cnJlbnRJbmRleF0ucHJldkluICE9PSAndW5kZWZpbmVkJykgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LHN0YXRlc1tjdXJyZW50SW5kZXhdLnByZXZJbih4RGF0YSkpO1xuXG4gICAgICAgIC8vIENhbGwgcmVuZGVyIG9uIG5ldyBjdXJyZW50IHN0YXRlO1xuICAgICAgICBpZiAodHlwZW9mIHN0YXRlc1tjdXJyZW50SW5kZXhdLnJlbmRlciAhPT0gJ3VuZGVmaW5lZCcpIHhEYXRhID0gT2JqZWN0LmFzc2lnbih7fSxzdGF0ZXNbY3VycmVudEluZGV4XS5yZW5kZXIoeERhdGEpKTtcbiAgICAgICAgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sZGF0YSx4RGF0YSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICBsZXQgcmVzaXplID0gKCkgPT4ge1xuICAgICAgICBsZXQgeERhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEpO1xuICAgICAgICB4RGF0YSA9IHN0YXRlc1tjdXJyZW50SW5kZXhdLnJlc2l6ZSh4RGF0YSk7XG4gICAgICAgIGRhdGEgPSBPYmplY3QuYXNzaWduKHt9LGRhdGEseERhdGEpO1xuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBuZXh0OiBuZXh0LFxuICAgICAgICBhZGQ6IGFkZCxcbiAgICAgICAgY3VycmVudFN0YXRlOiBjdXJyZW50U3RhdGUsXG4gICAgICAgIHByZXY6IHByZXYsXG4gICAgICAgIHJlbW92ZTogcmVtb3ZlLFxuICAgICAgICByZXNpemU6IHJlc2l6ZSxcbiAgICAgICAganVtcFRvOiBqdW1wVG8sXG4gICAgICAgIHN0YXJ0OiBzdGFydFxuICAgIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IFN0YXRlSGFuZGxlcjsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
